___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Redirect Link Tracker",
  "categories": ["ANALYTICS","UTILITY","CONVERSIONS"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Allows you to use redirects on URLs to fire GTM tracking events before redirecting to a destination on your website. For more information and demo see https://gtm2.markedmondson.me/redirect-gtm",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "PARAM_TABLE",
    "name": "redirects",
    "displayName": "URL redirects",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "path",
          "displayName": "Path",
          "simpleValueType": true,
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            },
            {
              "type": "REGEX",
              "args": [
                "^/(.+)"
              ]
            }
          ],
          "help": "This is the public URL that will redirect to the destination path once the GTM event is fired. Must start with /"
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "redirect",
          "displayName": "Destination",
          "simpleValueType": true,
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            },
            {
              "type": "REGEX",
              "args": [
                "^http(.+)"
              ]
            }
          ],
          "help": "This is the final URL destination on your website"
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "SELECT",
          "name": "status",
          "displayName": "HTTP Redirect Status",
          "macrosInSelect": true,
          "selectItems": [
            {
              "value": 301,
              "displayValue": "301 Permanent"
            },
            {
              "value": 302,
              "displayValue": "302 Temporary"
            }
          ],
          "simpleValueType": true,
          "help": "The type of redirect: 301 Permanent or 302 Temporary"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "TEXT",
          "name": "referrer",
          "displayName": "Referrer",
          "simpleValueType": true,
          "canBeEmptyString": true,
          "help": "You can optionally add a referer header to the URL redirect, to aid with tracking e.g. add example.com if the tracking URL is only shared on certain websites.  This may not override referrers if passed along"
        },
        "isUnique": false
      }
    ],
    "newRowButtonText": "Add URL redirect",
    "newRowTitle": "New URL redirect",
    "alwaysInSummary": true,
    "help": "Creates a redirect rule that can fire GTM events"
  }
]


___SANDBOXED_JS_FOR_SERVER___

const claimRequest = require('claimRequest');
const getRequestPath = require('getRequestPath');
const runContainer = require('runContainer');
const returnResponse = require('returnResponse');
const addEventCallback = require('addEventCallback');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');
const getTimestampMillis = require('getTimestampMillis');
const getRequestHeader = require('getRequestHeader');

const log = require('logToConsole');

log('data =', data);

const rows = data.redirects;

if(typeof rows === 'undefined') return data.gtmOnFailure();

rows.forEach((row) => {

  if(getRequestPath() == row.path){
    claimRequest();
    
    if(typeof row.referer === "undefined"){
      row.referer = getRequestHeader('Referer');
    }
    
    // make an event for this redirect
    const event = {
      event_name: 'redirect',
      redirect_source: row.path,
      redirect_destination: row.redirect,
      redirect_type: row.status,
      redirect_referer: row.referer,
      ts: getTimestampMillis()
    };
    
    log('event:', event);
    
    // run all containers for this client
    runContainer(event, () => data.gtmOnSuccess()); 
    
    // set response to a redirect
    redirectResponse(row.status, row.redirect, row.referer);
    
  }
});

function redirectResponse(status, location, referer){
    // set response to a redirect
    setResponseStatus(status);
    setResponseHeader('Location', location);
    setResponseHeader('Cache-Control', 'no-store, max-age=0');
    setResponseHeader('Referer', referer);
  
    returnResponse();

}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "pathAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "run_container",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "writeStatusAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "writeHeadersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "writeHeaderWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "location"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "cache-control"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: redirect
  code: "const mockData = {\n  redirects: [\n    {  \n      path: '/track_me_A',\n\
    \      redirect: 'https://code.markedmondson.me/edmonlytica',\n      type: '301'\n\
    \    },\n        {  \n      path: '/track_me_B',\n      redirect: 'https://code.markedmondson.me/',\n\
    \      type: '302'\n    }\n  ]\n};\n\n// Call runCode to run the template's code.\n\
    runCode(mockData);"


___NOTES___

Created on 31/03/2021, 17.05.24


